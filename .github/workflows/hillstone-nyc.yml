name: hillstone-nyc-watch

on:
  schedule:
    - cron: "*/11 * * * *"      # runs about every 11 minutes
    - cron: "*/5 20-23 * * *"   # runs every 5 minutes from 3 PM - 7 PM EST (peak hours)

  workflow_dispatch:            # lets you run it manually from the Actions tab

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install requests tweepy
      - name: Run watcher
        env:
          MERCHANT_ID: "278278"
          RESTAURANT_NAME: "Hillstone NYC"  
          TIMEZONE: "America/New_York"  
          NOTIFICATION_PREFIX: "ðŸ¸ðŸš¨ Hillstone NYC Resy ðŸš¨ðŸ¸"
          PARTY_SIZES: "2,4"          # scan both 2 and 4
          ENABLE_DINNER: "true"       # "true" / "false"
          ENABLE_LUNCH: "true"       # set "true" if you want lunch too
          DAYS_AHEAD: "8"             # how many days ahead to look for tables
          STEP_MIN: "15"              # 15-minute grid
          LINK_BASE: "https://reservations.getwisely.com/hillstone-park-avenue?g=midtown-parkave"   # booking page URL
          RENOTIFY_MINUTES: "180"   # re-notify cooldown (in minutes)
          # --- Re-notify suppression knobs ---
          LUNCH_MAX_DAYS: "2"        # no re-notify when >2 days away (first sighting only)
          DINNER_MAX_DAYS: "3"       # no re-notify when >3 days away (first sighting only)
          MILESTONES: ""        # re-notify when lead_days crosses these buckets (e.g., 3â†’1â†’0)
          DAILY_CAP_LUNCH: "2"         # max lunch alerts per slot per calendar day
          DAILY_CAP_DINNER: "0"        # 0 = no cap (allow multiple dinner alerts same day)

          # --- Notifications (pick one or both) ---
          PUSHOVER_USER: ${{ secrets.PUSHOVER_USER_HILLSTONE_NYC }}
          PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_TOKEN_HILLSTONE_NYC }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_HILLSTONE_NYC }}

          # --- X/Twitter (optional) ---
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}

          # --- GIST SETUP FOR DEDUPING ---
          GIST_ID: ${{ secrets.GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}

          # --- SUPABASE DATABASE ---
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

          # --- DEBUGGING TEMP ---
          DEBUG: "true"
          TEST_ALERT: "false"
          TEST_TWITTER: "false"  # set to "true" to send a test tweet on startup
          #TEST_FIXED_KEY: "Thu Oct 09|7:30 PM|2|Dinner"
        run: python watcher.py

      - name: Commit logs (if any)
        run: |
          if [ -f availability_log.csv ]; then
            git config user.email "actions@github.com"
            git config user.name "GitHub Actions"

            # Pull latest to avoid conflicts (with rebase to keep history clean)
            git fetch origin main
            git reset --soft origin/main 2>/dev/null || true

            # Stage and commit
            git add availability_log.csv
            git diff --cached --quiet || git commit -m "update logs [skip ci]"

            # Push with retry logic for race conditions
            for i in 1 2 3; do
              git push origin main && break
              echo "Push failed, retrying after pull..."
              git pull --rebase origin main
            done
          fi

