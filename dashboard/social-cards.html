<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoneWatch ‚Äî Social Cards</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ‚îÄ‚îÄ Shared design tokens (same as main dashboard) ‚îÄ‚îÄ */
        :root {
            --bg-primary:    #0a0a0f;
            --bg-secondary:  #12121a;
            --bg-card:       #1a1a24;
            --accent-gold:   #c9a962;
            --accent-gold-dim: rgba(201,169,98,0.15);
            --accent-rose:   #b4516d;
            --accent-emerald:#4a9d7c;
            --text-primary:  #f5f5f7;
            --text-secondary:#a0a0a8;
            --text-dim:      #6b6b75;
            --border-subtle: rgba(255,255,255,0.06);
            --gradient-gold: linear-gradient(135deg,#c9a962 0%,#a88b4a 100%);
            --gradient-card: linear-gradient(180deg,rgba(255,255,255,0.03) 0%,rgba(255,255,255,0) 100%);
            --shadow-glow:   0 0 60px rgba(201,169,98,0.1);
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        html { -webkit-font-smoothing:antialiased; }
        body { font-family:'Inter',sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; }

        /* ‚îÄ‚îÄ Page chrome ‚îÄ‚îÄ */
        .page-header {
            padding:1.25rem 2rem; border-bottom:1px solid var(--border-subtle);
            display:flex; align-items:center; justify-content:space-between;
        }
        .page-title { display:flex; align-items:baseline; gap:0.6rem; }
        .page-title h1 { font-family:'Playfair Display',serif; font-size:1.3rem; background:var(--gradient-gold); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .page-title span { font-size:0.72rem; color:var(--text-dim); letter-spacing:0.12em; text-transform:uppercase; }
        .back-link { font-size:0.78rem; color:var(--text-dim); text-decoration:none; transition:color .2s; }
        .back-link:hover { color:var(--accent-gold); }

        .controls {
            display:flex; align-items:center; gap:1rem; padding:0.9rem 2rem;
            border-bottom:1px solid var(--border-subtle); flex-wrap:wrap;
        }
        .controls-label { font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.1em; }
        .time-pills { display:flex; gap:0.35rem; }
        .time-pill {
            padding:0.3rem 0.8rem; border:1px solid var(--border-subtle); border-radius:20px;
            background:transparent; color:var(--text-secondary); font-size:0.75rem;
            cursor:pointer; font-family:'Inter',sans-serif; transition:all .15s;
        }
        .time-pill:hover { border-color:var(--accent-gold); color:var(--accent-gold); }
        .time-pill.active { background:rgba(201,169,98,0.15); border-color:var(--accent-gold); color:var(--accent-gold); font-weight:600; }
        .controls-hint { margin-left:auto; font-size:0.7rem; color:var(--text-dim); }

        .cards-outer { padding:1.5rem 2rem 2.5rem; overflow-x:auto; scrollbar-width:thin; scrollbar-color:rgba(255,255,255,0.08) transparent; }
        .cards-row { display:flex; gap:1.25rem; width:max-content; align-items:flex-start; }
        .card-wrapper { display:flex; flex-direction:column; align-items:center; gap:0.5rem; }

        /* Clipping preview ‚Äî 405px = 1080 √ó 0.375 */
        .card-preview {
            width:405px; height:405px; overflow:hidden; position:relative;
            border-radius:10px;
            box-shadow:0 8px 48px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.04);
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           THE CARDS ‚Äî everything inside is at
           1080 √ó 1080 design scale
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .card {
            width:1080px; height:1080px;
            position:absolute; top:0; left:0;
            transform:scale(0.375); transform-origin:top left;
            font-family:'Inter',sans-serif;
            background:var(--bg-primary);
            overflow:hidden;
        }

        /* ‚îÄ‚îÄ Scaled-up versions of dashboard primitives ‚îÄ‚îÄ */

        /* stat-card  (dashboard: ~375px viewport ‚Üí 1080px = √ó2.88 scale) */
        .sc-stat-card {
            background:var(--bg-card);
            background-image:var(--gradient-card);
            border:1px solid var(--border-subtle);
            border-radius:28px;
            padding:44px 50px;
            position:relative; overflow:hidden;
        }
        .sc-stat-card.highlight {
            border-color:rgba(201,169,98,0.3);
            box-shadow:var(--shadow-glow);
        }
        .sc-stat-label {
            font-size:24px; color:var(--text-dim);
            text-transform:uppercase; letter-spacing:0.1em;
            margin-bottom:14px;
        }
        .sc-stat-value {
            font-family:'Playfair Display',serif;
            font-size:88px; font-weight:600;
            color:var(--text-primary); line-height:1;
        }
        .sc-stat-card.highlight .sc-stat-value { color:var(--accent-gold); }
        .sc-stat-unit {
            font-size:32px; font-family:'Inter',sans-serif;
            font-weight:400; color:var(--text-secondary); margin-left:8px;
        }

        /* fact-card */
        .sc-fact-card {
            background:var(--bg-card);
            border:1px solid var(--border-subtle);
            border-radius:28px;
            padding:44px 50px;
            display:flex; align-items:flex-start; gap:36px;
        }
        .sc-fact-icon { font-size:64px; line-height:1; flex-shrink:0; }
        .sc-fact-content { flex:1; }
        .sc-fact-title {
            font-size:24px; color:var(--text-dim);
            text-transform:uppercase; letter-spacing:0.08em;
            margin-bottom:10px;
        }
        .sc-fact-value {
            font-size:38px; color:var(--text-primary); line-height:1.5;
        }
        .sc-fact-value strong { color:var(--accent-gold); font-weight:600; }

        /* intelligence block ‚Äî editorial big-stat style */
        .sc-intel-block {
            flex:1;
            background:var(--bg-card);
            border:1px solid var(--border-subtle);
            border-radius:28px;
            padding:48px 60px 44px;
            display:flex; flex-direction:column;
            position:relative; overflow:hidden;
        }
        .sc-intel-tag {
            font-size:20px; letter-spacing:0.22em; text-transform:uppercase;
            color:var(--text-dim); font-weight:500; margin-bottom:18px;
        }
        .sc-intel-stat {
            font-family:'Playfair Display',serif;
            font-size:122px; font-weight:700;
            color:var(--accent-gold);
            line-height:0.88; letter-spacing:-0.02em;
        }
        .sc-intel-copy {
            font-size:30px; color:var(--text-secondary);
            line-height:1.42; margin-top:22px;
        }
        .sc-intel-copy strong { color:var(--text-primary); font-weight:600; }

        /* chart-card */
        .sc-chart-card {
            background:var(--bg-card);
            background-image:var(--gradient-card);
            border:1px solid var(--border-subtle);
            border-radius:32px;
            padding:56px 60px;
            position:relative; overflow:hidden;
        }
        .sc-chart-title {
            font-family:'Playfair Display',serif;
            font-size:52px; font-weight:600; color:var(--text-primary);
        }
        .sc-chart-subtitle {
            font-size:28px; color:var(--text-dim); margin-top:8px;
        }

        /* Watermark */
        .card-wm {
            display:flex; align-items:center; gap:16px; opacity:0.45;
        }
        .wm-logo {
            width:36px; height:36px; border-radius:9px; object-fit:cover;
        }
        .wm-text { font-size:24px; color:var(--text-secondary); letter-spacing:0.04em; }

        /* Card inner layout */
        .card-inner {
            position:absolute; inset:0;
            padding:72px 76px;
            display:flex; flex-direction:column;
        }

        /* Card section header (used on chart + fact cards) */
        .card-section-hdr {
            display:flex; align-items:center; justify-content:space-between;
            margin-bottom:44px;
        }
        .card-hdr-left {}
        .card-hdr-eyebrow {
            font-size:22px; color:var(--text-dim); text-transform:uppercase;
            letter-spacing:0.14em; margin-bottom:8px;
        }
        .card-hdr-title {
            font-family:'Playfair Display',serif;
            font-size:56px; font-weight:600;
            background:var(--gradient-gold);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .card-hdr-right { text-align:right; }
        .card-hdr-logo { width:56px; height:56px; border-radius:14px; object-fit:cover; }

        /* Bottom row: watermark flush to bottom */
        .card-bottom {
            margin-top:auto;
            padding-top:28px;
            display:flex; align-items:center; justify-content:flex-end;
        }

        /* ‚îÄ‚îÄ Download button ‚îÄ‚îÄ */
        .dl-row { display:flex; align-items:center; justify-content:space-between; width:100%; }
        .card-seq { font-size:0.66rem; color:var(--text-dim); letter-spacing:0.05em; }
        .download-btn {
            padding:0.32rem 0.85rem; border:1px solid var(--border-subtle);
            border-radius:5px; background:transparent; color:var(--text-secondary);
            font-size:0.7rem; cursor:pointer; font-family:'Inter',sans-serif; transition:all .15s;
        }
        .download-btn:hover { border-color:var(--accent-gold); color:var(--accent-gold); }
        .download-btn:disabled { opacity:.45; cursor:default; }

        /* Loading */
        .loading-state { display:flex; align-items:center; justify-content:center; height:60vh; flex-direction:column; gap:1rem; color:var(--text-dim); }
        .spinner { width:28px; height:28px; border:2px solid var(--border-subtle); border-top-color:var(--accent-gold); border-radius:50%; animation:spin .75s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }

        .page-footer { padding:1rem 2rem; border-top:1px solid var(--border-subtle); text-align:center; font-size:0.7rem; color:var(--text-dim); }
        .page-footer a { color:inherit; text-decoration:none; }
    </style>
</head>
<body>

<div id="loadingState" class="loading-state">
    <div class="spinner"></div>
    <div style="font-size:.82rem">Loading StoneWatch data‚Ä¶</div>
</div>

<div id="mainContent" style="display:none">

    <div class="page-header">
        <div class="page-title"><h1>StoneWatch</h1><span>Social Cards</span></div>
        <a href="stonewatch-dashboard.html" class="back-link">‚Üê Dashboard</a>
    </div>

    <div class="controls">
        <span class="controls-label">Time range</span>
        <div class="time-pills">
            <button class="time-pill" onclick="setRange('7',this)">7 Days</button>
            <button class="time-pill" onclick="setRange('14',this)">14 Days</button>
            <button class="time-pill" onclick="setRange('30',this)">30 Days</button>
            <button class="time-pill active" onclick="setRange('all',this)">All Time</button>
        </div>
        <span class="controls-hint">‚Üì below each card downloads 1080√ó1080 PNG</span>
    </div>

    <div class="cards-outer"><div class="cards-row">

        <!-- ‚ñà‚ñà‚ñà‚ñà  CARD 1 ¬∑ THE NUMBERS  ‚ñà‚ñà‚ñà‚ñà -->
        <div class="card-wrapper">
            <div class="card-preview"><div class="card" id="card-1">
                <div class="card-inner">

                    <!-- Header -->
                    <div class="card-section-hdr">
                        <div class="card-hdr-left">
                            <div class="card-hdr-eyebrow">Hillstone NYC</div>
                            <div class="card-hdr-title">Reservation<br>Intelligence</div>
                        </div>
                        <img src="../stonewatch_logo_lo_res.png" class="card-hdr-logo" onerror="this.style.display='none'">
                    </div>

                    <!-- 2√ó2 stat grid -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; flex:1; align-content:start">
                        <div class="sc-stat-card highlight">
                            <div class="sc-stat-label">Slots Found</div>
                            <div class="sc-stat-value" id="s1-total">‚Äî</div>
                        </div>
                        <div class="sc-stat-card">
                            <div class="sc-stat-label">Unique Days</div>
                            <div class="sc-stat-value" id="s1-days">‚Äî</div>
                        </div>
                        <div class="sc-stat-card">
                            <div class="sc-stat-label">Avg Lead</div>
                            <div class="sc-stat-value" id="s1-lead">‚Äî<span class="sc-stat-unit">hrs</span></div>
                        </div>
                        <div class="sc-stat-card">
                            <div class="sc-stat-label">Peak Hour</div>
                            <div class="sc-stat-value" id="s1-peak">‚Äî</div>
                        </div>
                    </div>

                    <div class="card-bottom">
                        <div class="card-wm">
                            <img src="../stonewatch_logo_lo_res.png" class="wm-logo" onerror="this.style.display='none'">
                            <span class="wm-text">StoneWatch ¬∑ @stonewatchNYC</span>
                        </div>
                    </div>
                </div>
            </div></div>
            <div class="dl-row">
                <span class="card-seq">01 / 05 ‚Äî The Numbers</span>
                <button class="download-btn" onclick="dl('card-1','01-numbers',this)">‚Üì Download PNG</button>
            </div>
        </div>

        <!-- ‚ñà‚ñà‚ñà‚ñà  CARD 2 ¬∑ SLOTS BY HOUR  ‚ñà‚ñà‚ñà‚ñà -->
        <div class="card-wrapper">
            <div class="card-preview"><div class="card" id="card-2">
                <div class="card-inner">
                    <div class="card-section-hdr">
                        <div class="card-hdr-left">
                            <div class="card-hdr-eyebrow">Timing Breakdown</div>
                            <div class="card-hdr-title">Slots by Hour</div>
                        </div>
                        <img src="../stonewatch_logo_lo_res.png" class="card-hdr-logo" onerror="this.style.display='none'">
                    </div>

                    <div class="sc-chart-card" style="flex:1; display:flex; flex-direction:column;">
                        <div class="sc-chart-subtitle" style="margin-bottom:40px">Reservation time distribution ¬∑ 11am ‚Äì 9pm</div>
                        <div style="flex:1; position:relative; min-height:0">
                            <canvas id="card2-chart"></canvas>
                        </div>
                    </div>

                    <div class="card-bottom">
                        <div class="card-wm">
                            <img src="../stonewatch_logo_lo_res.png" class="wm-logo" onerror="this.style.display='none'">
                            <span class="wm-text">StoneWatch ¬∑ @stonewatchNYC</span>
                        </div>
                    </div>
                </div>
            </div></div>
            <div class="dl-row">
                <span class="card-seq">02 / 05 ‚Äî Slots by Hour</span>
                <button class="download-btn" onclick="dl('card-2','02-by-hour',this)">‚Üì Download PNG</button>
            </div>
        </div>

        <!-- ‚ñà‚ñà‚ñà‚ñà  CARD 3 ¬∑ DAY OF WEEK  ‚ñà‚ñà‚ñà‚ñà -->
        <div class="card-wrapper">
            <div class="card-preview"><div class="card" id="card-3">
                <div class="card-inner">
                    <div class="card-section-hdr">
                        <div class="card-hdr-left">
                            <div class="card-hdr-eyebrow">Day Pattern</div>
                            <div class="card-hdr-title">Day of Week</div>
                        </div>
                        <img src="../stonewatch_logo_lo_res.png" class="card-hdr-logo" onerror="this.style.display:'none'">
                    </div>

                    <div class="sc-chart-card" style="flex:1; display:flex; flex-direction:column;">
                        <div class="sc-chart-subtitle" style="margin-bottom:40px">Which days have the most availability</div>
                        <div style="flex:1; position:relative; min-height:0">
                            <canvas id="card3-chart"></canvas>
                        </div>
                    </div>

                    <div class="card-bottom">
                        <div class="card-wm">
                            <img src="../stonewatch_logo_lo_res.png" class="wm-logo" onerror="this.style.display='none'">
                            <span class="wm-text">StoneWatch ¬∑ @stonewatchNYC</span>
                        </div>
                    </div>
                </div>
            </div></div>
            <div class="dl-row">
                <span class="card-seq">03 / 05 ‚Äî Day of Week</span>
                <button class="download-btn" onclick="dl('card-3','03-by-day',this)">‚Üì Download PNG</button>
            </div>
        </div>

        <!-- ‚ñà‚ñà‚ñà‚ñà  CARD 4 ¬∑ THE INTELLIGENCE PT 1  ‚ñà‚ñà‚ñà‚ñà -->
        <div class="card-wrapper">
            <div class="card-preview"><div class="card" id="card-4">
                <div class="card-inner">

                    <!-- Slim header -->
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:48px">
                        <div style="font-size:22px; letter-spacing:0.22em; text-transform:uppercase; color:var(--text-dim); font-weight:500; font-family:'Inter',sans-serif">The Intelligence</div>
                        <img src="../stonewatch_logo_lo_res.png" class="card-hdr-logo" onerror="this.style.display='none'">
                    </div>

                    <div style="display:flex; flex-direction:column; gap:22px; flex:1">

                        <!-- SAME-DAY RUSH -->
                        <div class="sc-intel-block">
                            <div class="sc-intel-tag">üéØ&nbsp; Same-Day Rush</div>
                            <div class="sc-intel-stat" id="c4-b1-stat">‚Äî</div>
                            <div class="sc-intel-copy" id="c4-b1-copy">‚Äî</div>
                        </div>

                        <!-- WEEKDAY EDGE -->
                        <div class="sc-intel-block">
                            <div class="sc-intel-tag">üìÖ&nbsp; Weekday Edge</div>
                            <div class="sc-intel-stat" id="c4-b2-stat">‚Äî</div>
                            <div class="sc-intel-copy" id="c4-b2-copy">‚Äî</div>
                        </div>

                    </div>

                    <div class="card-bottom">
                        <div class="card-wm">
                            <img src="../stonewatch_logo_lo_res.png" class="wm-logo" onerror="this.style.display='none'">
                            <span class="wm-text">StoneWatch ¬∑ @stonewatchNYC</span>
                        </div>
                    </div>
                </div>
            </div></div>
            <div class="dl-row">
                <span class="card-seq">04 / 05 ‚Äî The Intelligence I</span>
                <button class="download-btn" onclick="dl('card-4','04-intelligence-1',this)">‚Üì Download PNG</button>
            </div>
        </div>

        <!-- ‚ñà‚ñà‚ñà‚ñà  CARD 5 ¬∑ THE INTELLIGENCE PT 2  ‚ñà‚ñà‚ñà‚ñà -->
        <div class="card-wrapper">
            <div class="card-preview"><div class="card" id="card-5">
                <div class="card-inner">

                    <!-- Slim header -->
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:48px">
                        <div style="font-size:22px; letter-spacing:0.22em; text-transform:uppercase; color:var(--text-dim); font-weight:500; font-family:'Inter',sans-serif">The Intelligence</div>
                        <img src="../stonewatch_logo_lo_res.png" class="card-hdr-logo" onerror="this.style.display='none'">
                    </div>

                    <div style="display:flex; flex-direction:column; gap:22px; flex:1">

                        <!-- OFF-PEAK WINS -->
                        <div class="sc-intel-block">
                            <div class="sc-intel-tag">‚è∞&nbsp; Off-Peak Wins</div>
                            <div class="sc-intel-stat" id="c5-b1-stat">‚Äî</div>
                            <div class="sc-intel-copy" id="c5-b1-copy">‚Äî</div>
                        </div>

                        <!-- (PARTY) SIZE MATTERS -->
                        <div class="sc-intel-block">
                            <div class="sc-intel-tag"><span style="opacity:0.42">(party)</span>&nbsp;Size Matters</div>
                            <div class="sc-intel-stat" id="c5-b2-stat">‚Äî</div>
                            <div class="sc-intel-copy" id="c5-b2-copy">‚Äî</div>
                        </div>

                    </div>

                    <div class="card-bottom">
                        <div class="card-wm">
                            <img src="../stonewatch_logo_lo_res.png" class="wm-logo" onerror="this.style.display='none'">
                            <span class="wm-text">StoneWatch ¬∑ @stonewatchNYC</span>
                        </div>
                    </div>
                </div>
            </div></div>
            <div class="dl-row">
                <span class="card-seq">05 / 05 ‚Äî The Intelligence II</span>
                <button class="download-btn" onclick="dl('card-5','05-intelligence-2',this)">‚Üì Download PNG</button>
            </div>
        </div>

    </div></div>

    <div class="page-footer">
        StoneWatch ‚Äî Reservation Intelligence for Hillstone NYC &nbsp;¬∑&nbsp;
        <a href="stonewatch-dashboard.html">‚Üê Back to Dashboard</a>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vegmyektpcavpuotlspp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_P-G0Ws_M3zsqb3puemcNuQ_DUm-h6we';

    let allData = [], filteredData = [], currentRange = 'all';
    let chartHour = null, chartDay = null;

    // Chart.js defaults (same as main dashboard)
    Chart.defaults.color = '#a0a0a8';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
    Chart.defaults.font.family = "'Inter', sans-serif";

    async function fetchSupabase() {
        const res = await fetch(
            `${SUPABASE_URL}/rest/v1/unique_slots?select=*&order=seen_at_iso.desc`,
            { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Range': '0-49999' } }
        );
        if (!res.ok) throw new Error('Supabase fetch failed');
        return res.json();
    }

    function fmtHour(h) {
        if (h === 0 || h === 24) return '12am';
        if (h === 12) return '12pm';
        if (h < 12) return `${h}am`;
        return `${h - 12}pm`;
    }

    function calcStats(data) {
        if (!data.length) return null;
        const n = data.length;
        const avgLead = data.reduce((s,d)=>s+(d.lead_hours||0),0) / n;

        const hourCounts = {};
        data.forEach(d => { if (d.hour_slot != null) hourCounts[d.hour_slot] = (hourCounts[d.hour_slot]||0)+1; });
        const peakHour = +Object.entries(hourCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || 18;

        const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const dayCounts = {};
        DAYS.forEach(d => dayCounts[d]=0);
        data.forEach(d => { if (d.weekday_slot) dayCounts[d.weekday_slot]=(dayCounts[d.weekday_slot]||0)+1; });
        const bestDay = DAYS.map(d=>({d,c:dayCounts[d]})).sort((a,b)=>b.c-a.c)[0]?.d || 'Mon';

        const uniqueDates = new Set(data.map(d=>(d.slot_at_iso||'').split('T')[0]).filter(Boolean)).size;

        const lunch  = data.filter(d=>d.service==='Lunch').length;
        const dinner = data.filter(d=>d.service==='Dinner').length;
        const lunchWins = lunch >= dinner;
        const svcRatio = lunchWins ? (lunch/(dinner||1)).toFixed(1) : (dinner/(lunch||1)).toFixed(1);

        const party2 = data.filter(d=>d.party_size===2).length;
        const party4 = data.filter(d=>d.party_size===4).length;
        const party2Ratio = (party2/(party4||1)).toFixed(1);

        const weekendN = (dayCounts['Sat']||0)+(dayCounts['Sun']||0);
        const weekdayPct = (((n-weekendN)/n)*100).toFixed(0);

        const primeN = [18,19,20,21].reduce((s,h)=>s+(hourCounts[h]||0),0);
        const primeTimePct = ((primeN/n)*100).toFixed(0);

        // same-day: lead < 12h
        const leadHourCounts = {};
        data.forEach(d => {
            const h = Math.min(Math.floor(d.lead_hours||0), 72);
            leadHourCounts[h] = (leadHourCounts[h]||0)+1;
        });
        const sameDaySlots = Object.entries(leadHourCounts).filter(([h])=>+h<12).reduce((s,[,c])=>s+c,0);
        const sameDayPct = ((sameDaySlots/n)*100).toFixed(0);

        return { n, avgLead, uniqueDates, peakHour, hourCounts, dayCounts, bestDay,
                 lunch, dinner, lunchWins, svcRatio,
                 party2, party4, party2Ratio,
                 weekdayPct, primeTimePct, sameDayPct, leadHourCounts };
    }

    function applyFilters() {
        const now = new Date();
        filteredData = allData.filter(r => {
            if (currentRange === 'all') return true;
            return (now - new Date(r.seen_at_iso)) / 86400000 <= +currentRange;
        });
        updateCards();
    }

    function setRange(range, el) {
        currentRange = range;
        document.querySelectorAll('.time-pill').forEach(p=>p.classList.remove('active'));
        el.classList.add('active');
        applyFilters();
    }

    // Inject innerHTML with <strong> tags ‚Äî same pattern as main dashboard
    function setHTML(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html; }

    function updateCards() {
        const s = calcStats(filteredData);
        if (!s) return;

        // ‚îÄ‚îÄ Card 1: Stats ‚îÄ‚îÄ
        document.getElementById('s1-total').textContent = s.n.toLocaleString();
        document.getElementById('s1-days').textContent  = s.uniqueDates;
        document.getElementById('s1-lead').innerHTML    = `${s.avgLead.toFixed(1)}<span class="sc-stat-unit">hrs</span>`;
        document.getElementById('s1-peak').textContent  = fmtHour(s.peakHour);

        // ‚îÄ‚îÄ Cards 2 & 3: Charts ‚îÄ‚îÄ
        updateHourChart(s);
        updateDayChart(s);

        // ‚îÄ‚îÄ Card 4: Intelligence I ‚îÄ‚îÄ
        setHTML('c4-b1-stat', `${s.sameDayPct}%`);
        setHTML('c4-b1-copy',
            `of slots appear within 12 hours of the reservation. Check frequently ‚Äî last-minute cancellations are your best friend.`);

        setHTML('c4-b2-stat', s.bestDay);
        setHTML('c4-b2-copy',
            `has the most availability. <strong>${s.weekdayPct}%</strong> of all slots fall on weekdays ‚Äî weekends are slim pickings.`);

        // ‚îÄ‚îÄ Card 5: Intelligence II ‚îÄ‚îÄ
        const offPeakPct = (100 - +s.primeTimePct);
        setHTML('c5-b1-stat', `${offPeakPct}%`);
        setHTML('c5-b1-copy',
            `of slots fall outside 6‚Äì9pm prime time. Go off-peak and the reservation game gets a whole lot easier.`);

        const biggerParty = s.party2 > s.party4 ? '2' : '4';
        const partyRatio  = s.party2 > s.party4
            ? (s.party2/(s.party4||1)).toFixed(1)
            : (s.party4/(s.party2||1)).toFixed(1);
        setHTML('c5-b2-stat', `${partyRatio}√ó`);
        setHTML('c5-b2-copy',
            `Tables for <strong>${biggerParty}</strong> are that much more common. Intimate dinners are easier to book ‚Äî bring one friend, not a crowd.`);
    }

    function chartTooltipDefaults() {
        return {
            backgroundColor: '#1a1a24',
            titleColor: '#f5f5f7',
            bodyColor: '#a0a0a8',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
        };
    }

    function updateHourChart(s) {
        const labels = [], data = [];
        for (let h = 11; h <= 21; h++) {
            labels.push(fmtHour(h));
            data.push(s.hourCounts?.[h] || 0);
        }
        if (chartHour) {
            chartHour.data.labels = labels;
            chartHour.data.datasets[0].data = data;
            chartHour.update('none');
            return;
        }
        const ctx = document.getElementById('card2-chart');
        chartHour = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: 'rgba(201,169,98,0.6)',
                    borderColor: 'rgba(201,169,98,1)',
                    borderWidth: 1,
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: 1,
                plugins: {
                    legend: { display: false },
                    tooltip: { ...chartTooltipDefaults(), callbacks: { label: ctx => `${ctx.raw} slots` } }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 22 }, color: '#a0a0a8' } },
                    y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { font: { size: 20 }, color: '#a0a0a8' } }
                }
            }
        });
    }

    function updateDayChart(s) {
        const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const data = days.map(d => s.dayCounts?.[d] || 0);
        const bgColors = data.map((_,i) => i >= 5 ? 'rgba(180,81,109,0.6)' : 'rgba(74,157,124,0.6)');
        const bdColors = data.map((_,i) => i >= 5 ? 'rgba(180,81,109,1)' : 'rgba(74,157,124,1)');

        if (chartDay) {
            chartDay.data.datasets[0].data = data;
            chartDay.data.datasets[0].backgroundColor = bgColors;
            chartDay.data.datasets[0].borderColor = bdColors;
            chartDay.update('none');
            return;
        }
        const ctx = document.getElementById('card3-chart');
        chartDay = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    data,
                    backgroundColor: bgColors,
                    borderColor: bdColors,
                    borderWidth: 1,
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: 1,
                plugins: {
                    legend: { display: false },
                    tooltip: { ...chartTooltipDefaults(), callbacks: { label: ctx => `${ctx.raw} slots` } }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 24 }, color: '#a0a0a8' } },
                    y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { font: { size: 20 }, color: '#a0a0a8' } }
                }
            }
        });
    }

    async function dl(cardId, filename, btn) {
        btn.textContent = 'Capturing‚Ä¶';
        btn.disabled = true;
        try {
            const card = document.getElementById(cardId);
            const canvas = await html2canvas(card, {
                width: 1080, height: 1080, scale: 2,
                useCORS: true, allowTaint: false,
                backgroundColor: '#0a0a0f', logging: false,
                onclone: (_doc, el) => {
                    el.style.transform = 'none';
                    el.style.position = 'static';
                    el.style.width = '1080px';
                    el.style.height = '1080px';
                }
            });
            const a = document.createElement('a');
            a.download = `stonewatch-${filename}.png`;
            a.href = canvas.toDataURL('image/png');
            a.click();
        } catch (err) {
            console.error(err);
            alert('Download failed ‚Äî try right-clicking to save.');
        } finally {
            btn.textContent = '‚Üì Download PNG';
            btn.disabled = false;
        }
    }

    async function init() {
        try {
            const raw = await fetchSupabase();
            const seen = new Set();
            allData = raw.filter(r => {
                if (!r.slot_at_iso || !r.service) return false;
                const k = `${r.slot_at_iso}-${r.party_size}-${r.service}`;
                if (seen.has(k)) return false;
                seen.add(k); return true;
            });
            filteredData = [...allData];
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            updateCards();
        } catch (err) {
            document.getElementById('loadingState').innerHTML = `
                <div style="text-align:center;color:var(--text-dim)">
                    <div style="font-size:2rem;margin-bottom:1rem">‚ö†Ô∏è</div>
                    <div>${err.message}</div>
                </div>`;
        }
    }

    init();
</script>
</body>
</html>
