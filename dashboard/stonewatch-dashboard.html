<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoneWatch Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-card-hover: #22222e;
            --accent-gold: #c9a962;
            --accent-gold-dim: rgba(201, 169, 98, 0.15);
            --accent-rose: #b4516d;
            --accent-emerald: #4a9d7c;
            --text-primary: #f5f5f7;
            --text-secondary: #a0a0a8;
            --text-dim: #6b6b75;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --gradient-gold: linear-gradient(135deg, #c9a962 0%, #a88b4a 100%);
            --gradient-card: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%);
            --shadow-glow: 0 0 60px rgba(201, 169, 98, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Password Screen */
        .password-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
        }

        .password-screen.hidden {
            display: none;
        }

        .password-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-glow);
        }

        .password-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .password-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }

        .password-input {
            width: 100%;
            max-width: 280px;
            padding: 1rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            letter-spacing: 0.1em;
            outline: none;
            transition: border-color 0.2s;
        }

        .password-input:focus {
            border-color: var(--accent-gold);
        }

        .password-input::placeholder {
            color: var(--text-dim);
            letter-spacing: normal;
        }

        .password-error {
            color: var(--accent-rose);
            font-size: 0.8rem;
            margin-top: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .password-error.show {
            opacity: 1;
        }

        /* Ambient background */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(201, 169, 98, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(180, 81, 109, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .main-content {
            display: none;
        }

        .main-content.visible {
            display: block;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 100%;
            padding: 1rem;
            padding-bottom: 5rem;
        }

        /* Sticky Header */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .sticky-header.visible {
            transform: translateY(0);
        }

        .sticky-header .sticky-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }

        .sticky-header .sticky-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.125rem;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Hero Header */
        .header {
            text-align: center;
            padding: 2rem 0 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-container {
            margin-bottom: 1rem;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            object-fit: cover;
            box-shadow: var(--shadow-glow);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Top Controls Bar */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
        }

        .toggle-group {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 4px;
            gap: 2px;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .toggle-btn:hover {
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            font-weight: 500;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: var(--border-subtle);
            margin: 0 0.25rem;
        }

        /* Time Range Pills */
        .time-range-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .time-pill {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-pill:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .time-pill.active {
            background: var(--accent-gold-dim);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            background-image: var(--gradient-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card.highlight {
            border-color: rgba(201, 169, 98, 0.3);
            box-shadow: var(--shadow-glow);
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.35rem;
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-card.highlight .stat-value {
            color: var(--accent-gold);
        }

        .stat-unit {
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 0.2rem;
        }

        /* Fast Facts */
        .fast-facts {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .fact-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .fact-icon {
            font-size: 1.5rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .fact-content {
            flex: 1;
        }

        .fact-title {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.25rem;
        }

        .fact-value {
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .fact-value strong {
            color: var(--accent-gold);
            font-weight: 600;
        }

        /* Charts */
        .chart-section {
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--bg-card);
            background-image: var(--gradient-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .chart-header {
            margin-bottom: 1rem;
        }

        .chart-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
        }

        .chart-container.lead-time {
            height: 280px;
        }

        /* GitHub-style Heatmap */
        .github-heatmap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.5rem;
        }

        .heatmap-wrapper {
            display: flex;
            gap: 0.5rem;
            min-width: fit-content;
        }

        .heatmap-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.25rem 0;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-months {
            display: flex;
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
            padding-left: 2px;
        }

        .heatmap-month {
            text-align: left;
        }

        .heatmap-row {
            display: flex;
            gap: 3px;
        }

        .heatmap-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.03);
        }

        .heatmap-cell[data-level="1"] { background: rgba(201, 169, 98, 0.2); }
        .heatmap-cell[data-level="2"] { background: rgba(201, 169, 98, 0.4); }
        .heatmap-cell[data-level="3"] { background: rgba(201, 169, 98, 0.6); }
        .heatmap-cell[data-level="4"] { background: rgba(201, 169, 98, 0.85); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.35rem;
            margin-top: 0.75rem;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .legend-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Sticky Footer */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-subtle);
            padding: 0.875rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .twitter-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .twitter-link:hover {
            color: var(--accent-gold);
        }

        .twitter-link svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
            gap: 1rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }

        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }

        /* Responsive */
        @media (min-width: 640px) {
            .container {
                max-width: 600px;
                margin: 0 auto;
                padding: 2rem;
                padding-bottom: 5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .fast-facts {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 2.5rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 900px;
            }

            .chart-container {
                height: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div class="password-screen" id="passwordScreen">
        <img src="../stonewatch_logo_lo_res.png" alt="StoneWatch" class="password-logo" onerror="this.style.display='none'">
        <h1 class="password-title">StoneWatch</h1>
        <p class="password-subtitle">Enter password to continue</p>
        <input type="password" class="password-input" id="passwordInput" placeholder="Password" autocomplete="off">
        <p class="password-error" id="passwordError">Incorrect password</p>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="ambient-bg"></div>

        <!-- Sticky Header -->
        <div class="sticky-header" id="stickyHeader">
            <img src="../stonewatch_logo_lo_res.png" alt="StoneWatch" class="sticky-logo" onerror="this.style.display='none'">
            <span class="sticky-title">StoneWatch</span>
        </div>

        <div class="container" id="app">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading availability data...</div>
            </div>
        </div>

        <!-- Sticky Footer -->
        <div class="sticky-footer">
            <a href="https://x.com/stonewatchNYC" target="_blank" rel="noopener" class="twitter-link">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
                Follow @stonewatchNYC
            </a>
        </div>
    </div>

    <script>
        // Password check
        const CORRECT_PASSWORD = 'martiniswap';
        const passwordScreen = document.getElementById('passwordScreen');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const mainContent = document.getElementById('mainContent');

        // Check if already authenticated
        if (sessionStorage.getItem('sw_auth') === 'true') {
            passwordScreen.classList.add('hidden');
            mainContent.classList.add('visible');
            initApp();
        } else {
            passwordInput.focus();
        }

        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (passwordInput.value === CORRECT_PASSWORD) {
                    sessionStorage.setItem('sw_auth', 'true');
                    passwordScreen.classList.add('hidden');
                    mainContent.classList.add('visible');
                    initApp();
                } else {
                    passwordError.classList.add('show');
                    passwordInput.value = '';
                    setTimeout(() => passwordError.classList.remove('show'), 2000);
                }
            }
        });

        // Global state
        let allData = [];
        let filteredData = [];
        let charts = {};
        let filters = {
            service: 'all',
            partySize: 'all',
            timeRange: 'all'
        };

        // Supabase config (read-only public access)
        // TODO: Replace with your Supabase project URL and anon key
        // Get these from: Supabase Dashboard > Settings > API
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';  // e.g., 'https://xxxx.supabase.co'
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';  // The 'anon' public key

        // Chart.js defaults
        Chart.defaults.color = '#a0a0a8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.06)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        async function fetchFromSupabase() {
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/availability_logs?select=*&order=seen_at_iso.desc`,
                {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                }
            );
            if (!response.ok) throw new Error('Supabase fetch failed');
            return await response.json();
        }

        async function fetchFromCSV() {
            const paths = [
                '../availability_log.csv',
                './availability_log.csv',
                '/stonewatch/availability_log.csv',
                'https://raw.githubusercontent.com/jacobschulman/stonewatch/main/availability_log.csv'
            ];

            for (const path of paths) {
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        const csvText = await response.text();
                        const parsed = Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            dynamicTyping: (field) => {
                                return !['seen_at_iso', 'slot_at_iso', 'service', 'weekday_slot', 'weekday_seen', 'source'].includes(field);
                            }
                        });
                        return parsed.data.filter(row => row.slot_at_iso && row.service && typeof row.slot_at_iso === 'string');
                    }
                } catch (e) {
                    continue;
                }
            }
            throw new Error('Could not load CSV data');
        }

        async function initApp() {
            try {
                let data = null;
                let dataSource = 'unknown';

                // Try Supabase first (primary), fall back to CSV
                try {
                    data = await fetchFromSupabase();
                    dataSource = 'supabase';
                    console.log(`‚úÖ Loaded ${data.length} rows from Supabase`);
                } catch (e) {
                    console.log('‚ö†Ô∏è Supabase unavailable, falling back to CSV...');
                    data = await fetchFromCSV();
                    dataSource = 'csv';
                    console.log(`‚úÖ Loaded ${data.length} rows from CSV`);
                }

                if (!data || data.length === 0) {
                    throw new Error('No data available');
                }

                // Deduplicate
                const seen = new Set();
                allData = data.filter(row => {
                    if (!row.slot_at_iso || !row.service) return false;
                    const key = `${row.slot_at_iso}-${row.party_size}-${row.service}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });

                console.log(`üìä ${allData.length} unique slots (source: ${dataSource})`);

                filteredData = [...allData];
                render();
                setupStickyHeader();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div>Unable to load data</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-dim);">${error.message}</div>
                    </div>
                `;
            }
        }

        function setupStickyHeader() {
            const header = document.querySelector('.header');
            const stickyHeader = document.getElementById('stickyHeader');

            if (!header) return;

            const observer = new IntersectionObserver(
                ([entry]) => {
                    stickyHeader.classList.toggle('visible', !entry.isIntersecting);
                },
                { threshold: 0, rootMargin: '-50px 0px 0px 0px' }
            );

            observer.observe(header);
        }

        function calculateStats(data) {
            if (!data.length) return {};

            const totalSlots = data.length;
            const uniqueDates = new Set(data.map(d => String(d.slot_at_iso || '').split('T')[0]).filter(Boolean)).size;
            const avgLeadHours = data.reduce((sum, d) => sum + (d.lead_hours || 0), 0) / data.length;

            // Hour distribution
            const hourCounts = {};
            data.forEach(d => {
                const hour = d.hour_slot;
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            });
            const peakHour = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0]?.[0];

            // Party size
            const party2 = data.filter(d => d.party_size === 2).length;
            const party4 = data.filter(d => d.party_size === 4).length;

            // Service
            const lunch = data.filter(d => d.service === 'Lunch').length;
            const dinner = data.filter(d => d.service === 'Dinner').length;

            // Weekday distribution
            const weekdayCounts = {};
            data.forEach(d => {
                const wd = d.weekday_slot;
                weekdayCounts[wd] = (weekdayCounts[wd] || 0) + 1;
            });

            // Lead time distribution by hour
            const leadHourCounts = {};
            data.forEach(d => {
                const hour = Math.floor(d.lead_hours || 0);
                const bucket = Math.min(hour, 72); // Cap at 72 hours
                leadHourCounts[bucket] = (leadHourCounts[bucket] || 0) + 1;
            });

            return {
                totalSlots,
                uniqueDates,
                avgLeadHours: avgLeadHours.toFixed(1),
                peakHour: formatHour(parseInt(peakHour)),
                peakHourRaw: parseInt(peakHour),
                party2,
                party4,
                party2Pct: ((party2 / totalSlots) * 100).toFixed(0),
                party4Pct: ((party4 / totalSlots) * 100).toFixed(0),
                lunch,
                dinner,
                lunchPct: ((lunch / totalSlots) * 100).toFixed(0),
                dinnerPct: ((dinner / totalSlots) * 100).toFixed(0),
                hourCounts,
                weekdayCounts,
                leadHourCounts
            };
        }

        function formatHour(hour) {
            if (hour === 0 || hour === 24) return '12am';
            if (hour === 12) return '12pm';
            if (hour < 12) return `${hour}am`;
            return `${hour - 12}pm`;
        }

        function applyFilters() {
            const now = new Date();

            filteredData = allData.filter(row => {
                // Service filter
                if (filters.service !== 'all' && row.service !== filters.service) return false;

                // Party size filter
                if (filters.partySize !== 'all' && row.party_size !== parseInt(filters.partySize)) return false;

                // Time range filter
                if (filters.timeRange !== 'all') {
                    const seenDate = new Date(row.seen_at_iso);
                    const daysDiff = (now - seenDate) / (1000 * 60 * 60 * 24);
                    if (daysDiff > parseInt(filters.timeRange)) return false;
                }

                return true;
            });

            updateCharts();
            updateStats();
            updateFastFacts();
        }

        function render() {
            const stats = calculateStats(allData);
            const app = document.getElementById('app');

            app.innerHTML = `
                <header class="header animate-in">
                    <div class="logo-container">
                        <img src="../stonewatch_logo_lo_res.png" alt="StoneWatch" class="logo" onerror="this.style.display='none'">
                    </div>
                    <h1>StoneWatch</h1>
                    <p class="subtitle">Reservation Intelligence</p>
                </header>

                <!-- Time Range -->
                <div class="time-range-pills animate-in delay-1">
                    <button class="time-pill" data-range="3" onclick="setTimeRange('3', this)">3 Days</button>
                    <button class="time-pill" data-range="7" onclick="setTimeRange('7', this)">7 Days</button>
                    <button class="time-pill" data-range="14" onclick="setTimeRange('14', this)">14 Days</button>
                    <button class="time-pill" data-range="30" onclick="setTimeRange('30', this)">30 Days</button>
                    <button class="time-pill active" data-range="all" onclick="setTimeRange('all', this)">All Time</button>
                </div>

                <!-- Controls Bar -->
                <div class="controls-bar animate-in delay-1">
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-filter="service" data-value="all" onclick="setFilter('service', 'all', this)">All</button>
                        <button class="toggle-btn" data-filter="service" data-value="Lunch" onclick="setFilter('service', 'Lunch', this)">Lunch</button>
                        <button class="toggle-btn" data-filter="service" data-value="Dinner" onclick="setFilter('service', 'Dinner', this)">Dinner</button>
                    </div>
                    <div class="divider"></div>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-filter="partySize" data-value="all" onclick="setFilter('partySize', 'all', this)">All</button>
                        <button class="toggle-btn" data-filter="partySize" data-value="2" onclick="setFilter('partySize', '2', this)">2 ppl</button>
                        <button class="toggle-btn" data-filter="partySize" data-value="4" onclick="setFilter('partySize', '4', this)">4 ppl</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid animate-in delay-2">
                    <div class="stat-card highlight">
                        <div class="stat-label">Slots Found</div>
                        <div class="stat-value" id="stat-total">${stats.totalSlots.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unique Days</div>
                        <div class="stat-value" id="stat-days">${stats.uniqueDates}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Lead</div>
                        <div class="stat-value" id="stat-lead">${stats.avgLeadHours}<span class="stat-unit">hrs</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Peak Hour</div>
                        <div class="stat-value" id="stat-peak">${stats.peakHour}</div>
                    </div>
                </div>

                <!-- Fast Facts -->
                <div class="fast-facts animate-in delay-2" id="fast-facts">
                    ${renderFastFacts(stats)}
                </div>

                <!-- Availability by Hour -->
                <div class="chart-section animate-in delay-3">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Slots by Hour</div>
                            <div class="chart-subtitle">Reservation time distribution</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="hourChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Day of Week -->
                <div class="chart-section animate-in delay-3">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Day of Week</div>
                            <div class="chart-subtitle">Which days have the most availability</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="weekdayChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- GitHub-style Heatmap -->
                <div class="chart-section animate-in delay-3">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Activity Heatmap</div>
                            <div class="chart-subtitle">Slots spotted over time</div>
                        </div>
                        <div class="github-heatmap">
                            <div id="heatmap"></div>
                        </div>
                    </div>
                </div>

                <!-- Lead Time Distribution -->
                <div class="chart-section animate-in delay-4">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Lead Time Distribution</div>
                            <div class="chart-subtitle">How far ahead slots appear (hours)</div>
                        </div>
                        <div class="chart-container lead-time">
                            <canvas id="leadTimeChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            initCharts();
        }

        function renderFastFacts(stats) {
            if (!stats.totalSlots) return '';

            // Calculate interesting facts
            const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const sortedDays = weekdays
                .map(d => ({ day: d, count: stats.weekdayCounts?.[d] || 0 }))
                .sort((a, b) => b.count - a.count);

            const bestDay = sortedDays[0]?.day || 'Thu';
            const worstDay = sortedDays[sortedDays.length - 1]?.day || 'Sun';

            // Weekend vs weekday
            const weekendCount = (stats.weekdayCounts?.['Sat'] || 0) + (stats.weekdayCounts?.['Sun'] || 0);
            const weekdayCount = stats.totalSlots - weekendCount;
            const weekdayPct = ((weekdayCount / stats.totalSlots) * 100).toFixed(0);

            // Prime time analysis (6-9pm)
            const primeTimeSlots = [18, 19, 20, 21].reduce((sum, h) => sum + (stats.hourCounts?.[h] || 0), 0);
            const primeTimePct = ((primeTimeSlots / stats.totalSlots) * 100).toFixed(0);

            // Same day slots (lead time < 12 hours)
            const sameDaySlots = Object.entries(stats.leadHourCounts || {})
                .filter(([h]) => parseInt(h) < 12)
                .reduce((sum, [, count]) => sum + count, 0);
            const sameDayPct = ((sameDaySlots / stats.totalSlots) * 100).toFixed(0);

            // Lunch vs dinner advantage
            const lunchAdvantage = stats.lunch > stats.dinner;
            const serviceDiff = Math.abs(stats.lunch - stats.dinner);
            const serviceRatio = lunchAdvantage
                ? (stats.lunch / (stats.dinner || 1)).toFixed(1)
                : (stats.dinner / (stats.lunch || 1)).toFixed(1);

            return `
                <div class="fact-card">
                    <div class="fact-icon">üéØ</div>
                    <div class="fact-content">
                        <div class="fact-title">Best Time to Check</div>
                        <div class="fact-value"><strong>${sameDayPct}%</strong> of slots appear within 12 hours. Check frequently for same-day cancellations.</div>
                    </div>
                </div>
                <div class="fact-card">
                    <div class="fact-icon">üìÖ</div>
                    <div class="fact-content">
                        <div class="fact-title">Day Strategy</div>
                        <div class="fact-value"><strong>${bestDay}</strong> has the most slots. <strong>${weekdayPct}%</strong> of availability is on weekdays vs weekends.</div>
                    </div>
                </div>
                <div class="fact-card">
                    <div class="fact-icon">üçΩÔ∏è</div>
                    <div class="fact-content">
                        <div class="fact-title">Service Insight</div>
                        <div class="fact-value"><strong>${lunchAdvantage ? 'Lunch' : 'Dinner'}</strong> has ${serviceRatio}x more availability. ${lunchAdvantage ? 'Consider a late lunch for easier booking.' : 'Dinner slots are surprisingly accessible.'}</div>
                    </div>
                </div>
                <div class="fact-card">
                    <div class="fact-icon">‚è∞</div>
                    <div class="fact-content">
                        <div class="fact-title">Prime Time</div>
                        <div class="fact-value">Only <strong>${primeTimePct}%</strong> of slots are 6-9pm prime time. Off-peak hours give you a major advantage.</div>
                    </div>
                </div>
                <div class="fact-card">
                    <div class="fact-icon">üë•</div>
                    <div class="fact-content">
                        <div class="fact-title">Party Size Edge</div>
                        <div class="fact-value">Tables for <strong>${stats.party2 > stats.party4 ? '2' : '4'}</strong> are ${stats.party2 > stats.party4 ? (stats.party2 / (stats.party4 || 1)).toFixed(1) : (stats.party4 / (stats.party2 || 1)).toFixed(1)}x more common. ${stats.party2 > stats.party4 ? 'Intimate dinners are easier to book.' : 'Group reservations have good availability.'}</div>
                    </div>
                </div>
                <div class="fact-card">
                    <div class="fact-icon">üí°</div>
                    <div class="fact-content">
                        <div class="fact-title">Pro Tip</div>
                        <div class="fact-value">Average lead time is <strong>${stats.avgLeadHours}h</strong>. Most slots appear ${parseFloat(stats.avgLeadHours) < 24 ? 'same-day' : '1-2 days out'}‚Äîset your alerts accordingly.</div>
                    </div>
                </div>
            `;
        }

        function updateFastFacts() {
            const stats = calculateStats(filteredData);
            const factsEl = document.getElementById('fast-facts');
            if (factsEl) {
                factsEl.innerHTML = renderFastFacts(stats);
            }
        }

        function setTimeRange(range, element) {
            filters.timeRange = range;
            document.querySelectorAll('.time-pill').forEach(pill => pill.classList.remove('active'));
            element.classList.add('active');
            applyFilters();
        }

        function setFilter(filterName, value, element) {
            filters[filterName] = value;
            document.querySelectorAll(`.toggle-btn[data-filter="${filterName}"]`).forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
            applyFilters();
        }

        function initCharts() {
            const stats = calculateStats(filteredData);

            // Hour chart
            const hourLabels = [];
            const hourData = [];
            for (let h = 11; h <= 21; h++) {
                hourLabels.push(formatHour(h));
                hourData.push(stats.hourCounts?.[h] || 0);
            }

            charts.hour = new Chart(document.getElementById('hourChart'), {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        data: hourData,
                        backgroundColor: 'rgba(201, 169, 98, 0.6)',
                        borderColor: 'rgba(201, 169, 98, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            titleColor: '#f5f5f7',
                            bodyColor: '#a0a0a8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            callbacks: {
                                label: ctx => `${ctx.raw} slots`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { font: { size: 10 } } }
                    }
                }
            });

            // Weekday chart
            const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const weekdayData = weekdays.map(d => stats.weekdayCounts?.[d] || 0);

            charts.weekday = new Chart(document.getElementById('weekdayChart'), {
                type: 'bar',
                data: {
                    labels: weekdays,
                    datasets: [{
                        data: weekdayData,
                        backgroundColor: weekdayData.map((_, i) =>
                            i >= 5 ? 'rgba(180, 81, 109, 0.6)' : 'rgba(74, 157, 124, 0.6)'
                        ),
                        borderColor: weekdayData.map((_, i) =>
                            i >= 5 ? 'rgba(180, 81, 109, 1)' : 'rgba(74, 157, 124, 1)'
                        ),
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            titleColor: '#f5f5f7',
                            bodyColor: '#a0a0a8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            callbacks: {
                                label: ctx => `${ctx.raw} slots`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 11 } } },
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { font: { size: 10 } } }
                    }
                }
            });

            // Lead time chart - hourly distribution
            const leadLabels = [];
            const leadData = [];
            const maxHour = 48; // Show up to 48 hours

            for (let h = 0; h <= maxHour; h++) {
                leadLabels.push(h);
                leadData.push(stats.leadHourCounts?.[h] || 0);
            }

            // Convert to percentages
            const totalForPct = leadData.reduce((a, b) => a + b, 0);
            const leadPctData = leadData.map(v => totalForPct > 0 ? (v / totalForPct) * 100 : 0);

            charts.leadTime = new Chart(document.getElementById('leadTimeChart'), {
                type: 'bar',
                data: {
                    labels: leadLabels,
                    datasets: [{
                        data: leadPctData,
                        backgroundColor: leadLabels.map(h => {
                            if (h < 6) return 'rgba(180, 81, 109, 0.7)';
                            if (h < 12) return 'rgba(201, 169, 98, 0.7)';
                            if (h < 24) return 'rgba(74, 157, 124, 0.6)';
                            return 'rgba(74, 157, 124, 0.4)';
                        }),
                        borderRadius: 2,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a24',
                            titleColor: '#f5f5f7',
                            bodyColor: '#a0a0a8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            callbacks: {
                                title: ctx => `${ctx[0].label}h ahead`,
                                label: ctx => `${ctx.raw.toFixed(1)}% of slots`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 9 },
                                maxRotation: 0,
                                callback: (val, idx) => idx % 6 === 0 ? val : ''
                            },
                            title: {
                                display: true,
                                text: 'Hours ahead',
                                color: '#6b6b75',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            ticks: {
                                font: { size: 10 },
                                callback: val => val + '%'
                            },
                            title: {
                                display: true,
                                text: '% of slots',
                                color: '#6b6b75',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            // GitHub-style heatmap
            renderGitHubHeatmap();
        }

        function renderGitHubHeatmap() {
            const heatmapEl = document.getElementById('heatmap');
            if (!heatmapEl) return;

            // Get date range from data
            const dates = filteredData.map(d => new Date(d.seen_at_iso));
            if (dates.length === 0) {
                heatmapEl.innerHTML = '<div style="color: var(--text-dim); font-size: 0.8rem; padding: 1rem;">No data for selected filters</div>';
                return;
            }

            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));

            // Count slots by date
            const dateCounts = {};
            filteredData.forEach(d => {
                const dateStr = d.seen_at_iso.split('T')[0];
                dateCounts[dateStr] = (dateCounts[dateStr] || 0) + 1;
            });

            const maxCount = Math.max(...Object.values(dateCounts), 1);

            // Build calendar grid (GitHub style: columns are weeks, rows are days)
            // Start from the beginning of the week containing minDate
            const startDate = new Date(minDate);
            startDate.setDate(startDate.getDate() - startDate.getDay()); // Go to Sunday

            const endDate = new Date(maxDate);
            endDate.setDate(endDate.getDate() + (6 - endDate.getDay())); // Go to Saturday

            // Group by weeks
            const weeks = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const week = [];
                for (let day = 0; day < 7; day++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const count = dateCounts[dateStr] || 0;
                    let level = 0;
                    if (count > 0) {
                        level = Math.min(4, Math.ceil((count / maxCount) * 4));
                    }
                    week.push({
                        date: dateStr,
                        count,
                        level,
                        month: currentDate.getMonth(),
                        day: currentDate.getDate()
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                weeks.push(week);
            }

            // Build month labels
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let monthLabels = '';
            let lastMonth = -1;
            weeks.forEach((week, i) => {
                const firstDay = week.find(d => d.day <= 7);
                if (firstDay && firstDay.month !== lastMonth && firstDay.day <= 7) {
                    monthLabels += `<span class="heatmap-month" style="width: ${15 * Math.min(4, weeks.length - i)}px">${months[firstDay.month]}</span>`;
                    lastMonth = firstDay.month;
                }
            });

            // Build grid
            const dayLabels = ['', 'Mon', '', 'Wed', '', 'Fri', ''];
            let gridHtml = '';

            for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                gridHtml += '<div class="heatmap-row">';
                weeks.forEach(week => {
                    const cell = week[dayOfWeek];
                    gridHtml += `<div class="heatmap-cell" data-level="${cell.level}" title="${cell.date}: ${cell.count} slots"></div>`;
                });
                gridHtml += '</div>';
            }

            heatmapEl.innerHTML = `
                <div class="heatmap-wrapper">
                    <div class="heatmap-labels">
                        ${dayLabels.map(l => `<span>${l}</span>`).join('')}
                    </div>
                    <div class="heatmap-grid">
                        <div class="heatmap-months">${monthLabels}</div>
                        ${gridHtml}
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span>Less</span>
                    <div class="legend-cell heatmap-cell" data-level="0"></div>
                    <div class="legend-cell heatmap-cell" data-level="1"></div>
                    <div class="legend-cell heatmap-cell" data-level="2"></div>
                    <div class="legend-cell heatmap-cell" data-level="3"></div>
                    <div class="legend-cell heatmap-cell" data-level="4"></div>
                    <span>More</span>
                </div>
            `;
        }

        function updateCharts() {
            const stats = calculateStats(filteredData);

            // Update hour chart
            const hourData = [];
            for (let h = 11; h <= 21; h++) {
                hourData.push(stats.hourCounts?.[h] || 0);
            }
            charts.hour.data.datasets[0].data = hourData;
            charts.hour.update('none');

            // Update weekday chart
            const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const weekdayData = weekdays.map(d => stats.weekdayCounts?.[d] || 0);
            charts.weekday.data.datasets[0].data = weekdayData;
            charts.weekday.update('none');

            // Update lead time chart
            const leadData = [];
            const maxHour = 48;
            for (let h = 0; h <= maxHour; h++) {
                leadData.push(stats.leadHourCounts?.[h] || 0);
            }
            const totalForPct = leadData.reduce((a, b) => a + b, 0);
            const leadPctData = leadData.map(v => totalForPct > 0 ? (v / totalForPct) * 100 : 0);
            charts.leadTime.data.datasets[0].data = leadPctData;
            charts.leadTime.update('none');

            // Update heatmap
            renderGitHubHeatmap();
        }

        function updateStats() {
            const stats = calculateStats(filteredData);
            document.getElementById('stat-total').textContent = stats.totalSlots?.toLocaleString() || '0';
            document.getElementById('stat-days').textContent = stats.uniqueDates || '0';
            document.getElementById('stat-lead').innerHTML = `${stats.avgLeadHours || '0'}<span class="stat-unit">hrs</span>`;
            document.getElementById('stat-peak').textContent = stats.peakHour || '-';
        }
    </script>
</body>
</html>
